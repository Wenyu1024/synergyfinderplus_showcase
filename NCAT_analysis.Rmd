---
title: "data preparation"
author: "wenyu"
date: "3/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```



```{r}
source("C:/Users/wenyu/Documents/work group Jing/Drugcomb/synergyfinder/synergyfinderplus_showcase/functions.R")
data <- get_triocomb_data(id = 12255) 
data1 <- data %>% 
  # mutate_at(6:8, .funs = function(x){x*1000}) 
  filter(block_id==1) %>% 
  # filter(drug3== "Atazanavir") %>% 
  # filter(Replicate== 1)

library(synergyfinder)
res <- ReshapeData(data1, data_type = "inhibition")

# Plot monotherapy dose-response curves and dose response matrix
PlotDoseResponse(res, statistic = "ci", block_ids = 1,save_file = T,width = 30,height = 15)
Plot2DrugSurface(res, plot_block = 1)

# Calculate and visualize synergy scores
res_hsa <- CalculateSynergy(res, method = c("HSA"))
res_Bliss <- CalculateSynergy(res, method = c("Bliss"))
res_loewe <- CalculateSynergy(res, method = c("Loewe"))
res_zip <- CalculateSynergy(res, method = c("ZIP"))

# 2D heatmap with 95% confidence intervals
Plot2DrugHeatmap(res_hsa,plot_value = "HSA_synergy", plot_block = 1, statistic = "ci") 
Plot2DrugHeatmap(res_Bliss,plot_value = "Bliss_synergy", plot_block = 1, statistic = "ci")  
# 2D heatmap with 95% confidence intervals and mean hsa synergy for whole matrix
Plot2DrugHeatmap(res_loewe, plot_value = "Loewe_synergy", plot_block = 1,
                 statistic = "ci", summary_statistic = "mean")
Plot2DrugHeatmap(res_zip, plot_value = "ZIP_synergy", plot_block = 1,
                 statistic = "ci", summary_statistic = "mean")
# 3D landscape
Plot2DrugSurface(res_hsa, plot_value = "HSA_synergy", plot_block = 1)
Plot2DrugSurface(res_zip, plot_value = "ZIP_synergy", plot_block = 1)


```



search for drugs 
```{r}
library(synergyfinder)

metatable <- read_csv("C:/Users/wenyu/Documents/work group Jing/Drugcomb/synergyfinder/synergyfinderplus_showcase/data/assay/metatable.csv")
id_list <- metatable %>% filter(comb==3) %>% pull(id)


# tmp <- get_synergy_summary(11345)
res_summary <- map(.x = id_list,.f = get_synergy_summary)


save(res_summary, file = "C:/Users/wenyu/Documents/work group Jing/Drugcomb/synergyfinder/synergyfinderplus_showcase/Malaria_TACT_hsasummary.RData" )
res_df <- metatable %>% filter(comb==3) %>% 
  inner_join(y = res_summary %>% tibble() %>% bind_cols(id= id_list), by= "id" ) %>% 
  unnest()
```

Synergistic example id 11336 block 1
```{r}
library(synergyfinder)
data <- get_triocomb_data(id = 11336) 
data1 <- data 
  filter(block_id==1)
  # filter(Replicate== 1)
  
res_response = ReshapeData(data1, data_type = "viability")
res_hsa <- CalculateSynergy(res_response, method = c("HSA"))
# tmp1 <- res_hsa$synergy_scores
res_Bliss <- CalculateSynergy(res_response, method = c("Bliss"))
res_loewe <- CalculateSynergy(res_response, method = c("Loewe"))
res_zip <- CalculateSynergy(res_response, method = c("ZIP"))
PlotMultiDrugSurface(res_response, plot_block = 1, plot_value = "response")
PlotMultiDrugSurface(res_hsa, plot_block = 1, plot_value = "HSA_synergy") # four synerg score
PlotMultiDrugSurface(res_Bliss, plot_block = 1, plot_value = "Bliss_synergy")
PlotMultiDrugSurface(res_loewe, plot_block = 1, plot_value = "Loewe_synergy")
PlotMultiDrugSurface(res_zip, plot_block = 1, plot_value = "ZIP_synergy")
```


antagonistic example id 11911 block4

https://stackoverflow.com/questions/43355444/how-can-i-save-plotly-graphs-in-high-quality
```{r}
library(synergyfinder)
data <- get_triocomb_data(id = 11911) 
data1 <- data %>% filter(block_id==4)
res_response = ReshapeData(data1, data_type = "viability")
res_hsa <- CalculateSynergy(res_response, method = c("HSA"))
res_Bliss <- CalculateSynergy(res_response, method = c("Bliss"))
res_loewe <- CalculateSynergy(res_response, method = c("Loewe"))
res_zip <- CalculateSynergy(res_response, method = c("ZIP"))


p <- PlotMultiDrugSurface(res_response, plot_block = 4, plot_value = "response")
p
p %>% plotly::orca(file = "filename.svg")
         selenium = RSelenium::rsDriver(browser = "chrome"))

PlotMultiDrugSurface(res_hsa, plot_block = 4, plot_value = "HSA_synergy") # four synerg score
PlotMultiDrugSurface(res_Bliss, plot_block = 4, plot_value = "Bliss_synergy")
PlotMultiDrugSurface(res_loewe, plot_block = 4, plot_value = "Loewe_synergy")
PlotMultiDrugSurface(res_zip, plot_block = 4, plot_value = "ZIP_synergy")
```


